name: Check Qase Test Run Status

on:
  schedule:
    - cron: '*/1 * * * *'  # Setiap 1 menit
  workflow_dispatch:       # Bisa dijalankan manual
  push:
    branches:
      - main  # Pastikan workflow hanya berjalan di branch 'main'

jobs:
  check-qase-run:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get install jq

      - name: Call Qase API
        env:
          QASE_API_TOKEN: ${{ secrets.QASE_API_TOKEN }}
          QASE_PROJECT_CODE: ${{ secrets.QASE_PROJECT_CODE }}
          QASE_RUN_ID: ${{ secrets.QASE_RUN_ID }}
        run: |
          echo "‚è≥ Checking Qase test run status..."
    
          # Call the Qase API and capture both response and HTTP status code
          RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
            -X GET "https://api.qase.io/v2/${QASE_PROJECT_CODE}/run/${QASE_RUN_ID}" \
            -H "Content-Type: application/json" \
            -H "Token: ${QASE_API_TOKEN}")
      
          # Extract HTTP status code
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "‚ùå API request failed with status: $HTTP_STATUS"
            cat response.json
            exit 1
          fi
          
          # Extract the result from the response
          RESULT=$(cat response.json)
          STATUS=$(echo "$RESULT" | jq -r '.result.status')
      
          echo "Raw response:"
          echo "$RESULT"
      
          echo "üîç Qase Test Run Status: $STATUS"
          
          # Check if the test run is completed
          if [ "$STATUS" = "completed" ]; then
            echo "‚úÖ Test run is completed."
          else
            echo "üöß Test run is still active."
            exit 1  
          fi
